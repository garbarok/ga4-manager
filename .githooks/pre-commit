#!/bin/bash
# Pre-commit hook to prevent committing sensitive files
#
# Installation:
#   cp .githooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or configure git to use this directory:
#   git config core.hooksPath .githooks

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for .env files
if git diff --cached --name-only | grep -E "^\.env$|\.env\.local$"; then
    echo -e "${RED}ERROR: Attempting to commit .env file!${NC}"
    echo "This file should never be committed as it contains secrets."
    echo "If this is .env.example, rename it properly."
    exit 1
fi

# Check for credential files
if git diff --cached --name-only | grep -E "credentials.*\.json$|service-account.*\.json$|.*\.pem$|.*\.key$"; then
    echo -e "${RED}ERROR: Attempting to commit credential files!${NC}"
    echo "The following files should not be committed:"
    git diff --cached --name-only | grep -E "credentials.*\.json$|service-account.*\.json$|.*\.pem$|.*\.key$"
    exit 1
fi

# Check for common secret patterns in staged changes
# Only scan Go source code files (exclude tests, docs, scripts, configs)
SECRETS_FOUND=0

# Get only Go source files (exclude tests and all documentation)
# Also exclude this hook file and any shell scripts
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.go$" | grep -v "_test\.go$" || true)
STAGED_FILES_FOR_SCAN=$(git diff --cached --name-only --diff-filter=ACMR | grep -vE "\.githooks/|\.sh$|\.md$|\.txt$|\.example$|scripts/" || true)

# Check for API keys in Go source files only
if [ -n "$STAGED_GO_FILES" ]; then
    if git diff --cached -- $STAGED_GO_FILES | grep -iE "api[_-]?key\s*[:=]\s*['\"][a-zA-Z0-9]{20,}['\"]"; then
        echo -e "${YELLOW}WARNING: Potential API key found in Go source files${NC}"
        git diff --cached -- $STAGED_GO_FILES | grep -iE "api[_-]?key\s*[:=]\s*['\"][a-zA-Z0-9]{20,}['\"]"
        SECRETS_FOUND=1
    fi

    # Check for passwords in Go source files only (exclude any lines with /path/to/ or placeholder patterns)
    if git diff --cached -- $STAGED_GO_FILES | grep -iE "password\s*[:=]\s*['\"][^'\"]{8,}['\"]" | grep -viE "/path/to/|placeholder|example|your-|test"; then
        echo -e "${YELLOW}WARNING: Potential password found in Go source files${NC}"
        git diff --cached -- $STAGED_GO_FILES | grep -iE "password\s*[:=]\s*['\"][^'\"]{8,}['\"]" | grep -viE "/path/to/|placeholder|example|your-|test"
        SECRETS_FOUND=1
    fi

    # Check for hardcoded credential paths in Go source files (exclude placeholder patterns)
    if git diff --cached -- $STAGED_GO_FILES | grep -E "GOOGLE_APPLICATION_CREDENTIALS\s*[:=]\s*\"[^\"]*\.(json|pem|key)\"" | grep -viE "/path/to/|/nonexistent/|/fake/|placeholder|example|your|yourusername|\.example"; then
        echo -e "${YELLOW}WARNING: Hardcoded credential path in Go source files${NC}"
        echo "Credentials should be loaded from environment variables."
        git diff --cached -- $STAGED_GO_FILES | grep -E "GOOGLE_APPLICATION_CREDENTIALS\s*[:=]\s*\"[^\"]*\.(json|pem|key)\"" | grep -viE "/path/to/|/nonexistent/|/fake/|placeholder|example|your|yourusername|\.example"
        SECRETS_FOUND=1
    fi
fi

# Check for Google Cloud service account keys (JSON structure) in all files
if git diff --cached | grep -E "\"type\":\s*\"service_account\""; then
    echo -e "${RED}ERROR: Google Cloud service account JSON detected!${NC}"
    echo "You are attempting to commit a service account credential file."
    exit 1
fi

if [ $SECRETS_FOUND -eq 1 ]; then
    echo ""
    echo -e "${YELLOW}Potential secrets detected in your commit.${NC}"
    echo "Please review the changes carefully."
    echo ""
    read -p "Do you want to continue anyway? (yes/no): " -n 3 -r
    echo
    if [[ ! $REPLY =~ ^yes$ ]]; then
        echo "Commit aborted."
        exit 1
    fi
fi

# Run go fmt check
UNFORMATTED=$(gofmt -l .)
if [ -n "$UNFORMATTED" ]; then
    echo -e "${YELLOW}WARNING: The following files are not formatted:${NC}"
    echo "$UNFORMATTED"
    echo ""
    read -p "Run 'gofmt -w .' to format? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        gofmt -w .
        echo "Files formatted. Please review and stage the changes."
        exit 1
    fi
fi

# Success
echo -e "\033[0;32mâœ“ Pre-commit checks passed${NC}"
exit 0
